
<!DOCTYPE html>
<html>
<head>
  <title>The Musical Turing Test</title>
  <script src="https://unpkg.com/jspsych@8.2.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.1.0"></script>
  <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" type="text/css" />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: "Times New Roman", Times, serif;
      background-color: #DFF6E4;
      color: #333;
    }
    .jspsych {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .jspsych-content {
      font-size: 3em;
      text-align: center;
      padding: 2em;
      box-sizing: border-box;
    }
  </style>
</head>

<body>
<script>
var participant_id = ""; // global variable

var jsPsych = initJsPsych({
  on_finish: function() {
    // debug output
    console.table(
      jsPsych.data.get()
        .filter({trial_type:'audio-keyboard-response'})
        .select(['stimulus','response','correct','participant_id','rt'])
        .values()
    );
  }
});

// --- Timeline ---
var timeline = [];

// --- Participant ID trial ---
var participant_id_trial = {
  type: jsPsychSurveyText,
  questions: [{prompt:"Enter your participant ID:", required:true}],
  on_finish: function(data) {
    const resp = JSON.parse(data.responses);
    participant_id = resp.Q0 || "unknown";

    // --- Build the rest of the timeline dynamically ---

    // Welcome
    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: "<h1>The Musical Turing Test</h1><p>Press any key to begin.</p>"
    });

    // Instructions
    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <h2>Welcome to the experiment!</h2>
        <p>-----------------------------------------------------------</p>
        <p>You will hear a few short musical phrases with a harpsichord sound.</p>
        <p>If you think the music was composed by a <strong>Human</strong>, press <strong>H</strong>.</p>
        <p>If you think the music was composed by <strong>Artificial Intelligence</strong>, press <strong>A</strong>.</p>
        <p>Press any key to begin.</p>
      `
    });

    // Audio files
    var audio_files = [
      {file:"data/H/122.6-4.wav", label:"h"},
      {file:"data/H/148.6-6.wav", label:"h"},
      {file:"data/H/175.5-5.wav", label:"h"},
      {file:"data/A/output10-6.wav", label:"a"},
      {file:"data/A/output14-6.wav", label:"a"},
      {file:"data/A/output21-1.wav", label:"a"}
    ];

    var shuffled_files = jsPsych.randomization.shuffle(audio_files);

    // Audio trials
    shuffled_files.forEach((trial_info,i)=>{
      timeline.push({
        type: jsPsychAudioKeyboardResponse,
        stimulus: trial_info.file,
        choices: ["a","h"],
        prompt: `<p>Was this composed by a human (<strong>H</strong>) or AI (<strong>A</strong>)?</p>
                 <p style="margin-top:10px;font-weight:bold;">Trial ${i+1} / ${shuffled_files.length}</p>`,
        data: {
          correct: trial_info.label,
          participant_id: participant_id
        },
        response_ends_trial: true
      });
    });

    // Final screen
    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function(){
        const trials = jsPsych.data.get().filter({trial_type:'audio-keyboard-response'}).values();
        const correct_trials = trials.filter(t=>t.response?.toLowerCase()===t.correct?.toLowerCase()).length;
        const total_trials = trials.length;
        const accuracy = Math.round(correct_trials/total_trials*100);

        // Save CSV
        const csv = jsPsych.data.get().filter({trial_type:'audio-keyboard-response'}).csv();
        const blob = new Blob([csv], {type:"text/csv"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `results_${participant_id}.csv`;
        a.click();
        URL.revokeObjectURL(url);

        return `<h2>Thank you for participating!</h2>
                <p>Your score: ${correct_trials} / ${total_trials} (${accuracy}%) correct</p>
                <p>Results saved as results_${participant_id}.csv</p>
                <p>Press any key to finish.</p>`;
      }
    });

    // --- Run the rest of the timeline ---
    jsPsych.run(timeline);
  }
};

// --- Start only with ID trial ---
jsPsych.run([participant_id_trial]);
</script>
</body>
</html>
