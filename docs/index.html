<!DOCTYPE html>
<html>
  <head>
    <title>The Musical Turing Test</title>
    <!-- JSpsych core and plugins -->
    <script src="https://unpkg.com/jspsych@8.2.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.1.0"></script>
    <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <style>
      html, body {
        height: 80%;
        margin: 0;
        font-family: "Lato", sans-serif;
        background-color: #DFF6E4; /* pastel mint */
        color: #333333;
      }

      .jspsych {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 80vh;
      }

      .jspsych-content {
        font-family: "Lato", sans-serif;
        font-size: 2.5em;
        text-align: center;
        padding: 1em;
        box-sizing: border-box;
      }
    </style>
  </head>

  <body>
    <script>
      // --- Initialize jsPsych ---
      var timestamp = new Date().toISOString().replace(/[:.]/g, "-");

      var jsPsych = initJsPsych({
        on_finish: function() {
          // debug output
          console.table(
            jsPsych.data.get()
              .filter({ trial_type: 'audio-keyboard-response' })
              .select(['stimulus', 'response', 'correct', 'participant_id', 'rt'])
              .values()
          );
        }
      });

      var timeline = [];

      // --- Welcome ---
      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<h1>The Musical Turing Test</h1><p>Press any key to begin.</p>"
      });

      // --- Instructions ---
      timeline.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <h2>Welcome to the experiment!</h2>
          <p>-----------------------------------------------------------</p>
          <p>You will hear a few short musical phrases with a harpsichord sound.</p>
          <p>If you think the music was composed by a <strong>Human</strong>, press <strong>H</strong>.</p>
          <p>If you think the music was composed by <strong>Artificial Intelligence</strong>, press <strong>A</strong>.</p>
          <p>First, you can test how the experiment works.</p>
          <p>Press any key to begin the test.</p>
        `,
        post_trial_gap: 1000
      });

      // --- Audio files ---
      var audio_files = [];

      var human_files = [
        "data/H/122.6-4.wav",
        "data/H/148.6-6.wav",
        "data/H/175.5-5.wav",
        "data/H/227.11-5.wav",
        "data/H/244.15-6.wav",
        "data/H/256-5.wav",
        "data/H/276-8.wav",
        "data/H/283-7.wav",
        "data/H/290-2.wav",
        "data/H/292-2.wav",
        "data/H/294-4.wav",
        "data/H/325-5.wav",
        "data/H/368-7.wav",
        "data/H/375-1.wav",
        "data/H/402-8.wav",
        "data/H/426-6.wav",
        "data/H/428-3.wav",
        "data/H/5.7-2.wav",
        "data/H/65.7-5.wav",
        "data/H/90.5-6.wav",
      ];
      human_files.forEach(f => audio_files.push({file: f, label: "h"}));

      var ai_files = [
        "data/A/output10-6.wav",
        "data/A/output14-6.wav",
        "data/A/output16-1.wav",
        "data/A/output19-1.wav",
        "data/A/output21-1.wav",
        "data/A/output26-4.wav",
        "data/A/output28-2.wav",
        "data/A/output3-3.wav",
        "data/A/output31-5.wav",
        "data/A/output39-6.wav",
        "data/A/output48-2.wav",
        "data/A/output58-3.wav",
        "data/A/output61-3.wav",
        "data/A/output64-3.wav",
        "data/A/output67-3.wav",
        "data/A/output70-1.wav",
        "data/A/output75-1.wav",
        "data/A/output77-3.wav",
        "data/A/output79-3.wav",
        "data/A/output80-2.wav",
        "data/A/output81-3.wav",
      ];
      ai_files.forEach(f => audio_files.push({file: f, label: "a"}));

      // Shuffle
      var shuffled_files = jsPsych.randomization.shuffle(audio_files);

     // Training phase
      var first_trial = shuffled_files.shift();

      var training_audio = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: first_trial.file,
        choices: ["a", "h"],
        prompt: `<h2>Test phase</h2>
        <p>Was this composed by a human (<strong>H</strong>) or AI (<strong>A</strong>)?</p>
          `,
        data: {correct: first_trial.label, training: true},
        on_finish: function(data) {
          data.correct_response = data.response?.toLowerCase() === first_trial.label;
          console.log(data.response, first_trial.label);
        }
      };

      var training_feedback = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
          const last_trial = jsPsych.data.get().last(1).values()[0];

          if (last_trial.correct_response) {
            return `<h2 style='color:green;'>Correct!</h2>
              <p>Now you know how this works.</p>
              <p>Press SPACE to start the experiment!</p>`;
          } else {
            return `<h2 style='color:red;'>Unfortunately not correct.</h2>
              <p>But now you know how this works.</p>
              <p>Press SPACE to start the experiment!</p>`;
          };
          },
        choices: [" "],
        post_trial_gap: 500
        };
      timeline.push(training_audio);
      timeline.push(training_feedback);

      // --- Audio trials ---
      for (let i = 0; i < shuffled_files.length; i++) {
        let trial_info = shuffled_files[i];
        timeline.push({
          type: jsPsychAudioKeyboardResponse,
          stimulus: trial_info.file,
          choices: ["a","h"],
          prompt: `
            <p>Was this composed by a human (<strong>H</strong>) or AI (<strong>A</strong>)?</p>
            <p style="margin-top:10px; font-weight:bold;">Trial ${i+1} / ${shuffled_files.length}</p>
          `,
          data: function() {
            return {
              correct: trial_info.label,
              timestamp: timestamp,
              training: false
            };
          },
          response_ends_trial: true,
          post_trial_gap: 500,
        });
      }

      // --- Final screen ---
      var final_screen = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
          const trials = jsPsych.data.get()
            .filter({trial_type:'audio-keyboard-response', training:false})
            .values();

          const correct_trials = trials.filter(t => t.response?.toLowerCase() === t.correct?.toLowerCase()).length;
          const total_trials = trials.length;
          const accuracy = Math.round((correct_trials / total_trials) * 100);

          return `
              <h2>Thank you for participating!</h2>
            <p>Your score: ${correct_trials} / ${total_trials} (${accuracy}%) correct</p>
            <p>Press any key to finish the experiment and download the data.</p>
            `;
          },
        on_finish: function() {

          // Save CSV including participant_id
          const csv = jsPsych.data.get()
            .filter({trial_type:'audio-keyboard-response'})
            .csv();

          const blob = new Blob([csv], {type:"text/csv"});
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `results_${timestamp}.csv`
          a.click();
          URL.revokeObjectURL(url);
        }
      };
      timeline.push(final_screen);

      // --- Run experiment ---
      jsPsych.run(timeline);
    </script>
  </body>
</html>
